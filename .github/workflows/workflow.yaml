name: Test
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

env:
  TINYGO_VERSION: 0.25.0

jobs:
  style:
    name: Code style check
    runs-on: ubuntu-latest
    steps:
      - name: install Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.18'

      - name: checkout
        uses: actions/checkout@v3

      - name: run lint
        run: make lint

      - name: run format check
        run: make check

  sdk-tests:
    name: SDK tests
    runs-on: ubuntu-latest
    steps:
      - name: install Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.18'

      - name: checkout
        uses: actions/checkout@v3

      - name: run tests
        run: make test

  examples:
    name: Build examples
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Cache built examples
        uses: actions/cache@v3
        id: cache-built-examples
        with:
          path: examples
          key: examples-${{ hashFiles('examples/**', 'proxywasm/**', 'Makefile') }}-tinygo-${{ env.TINYGO_VERSION }}

      - name: Install Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.18'

      - name: Install TinyGo
        run: |
          gh release download v${TINYGO_VERSION} -p '*.linux-amd64.tar.gz' -D ~ -R github.com/tinygo-org/tinygo
          tar -xf ~/tinygo${TINYGO_VERSION}.linux-amd64.tar.gz  -C $HOME
          echo "$HOME/tinygo/bin" >> $GITHUB_PATH
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build examples
        if: steps.cache-built-examples.outputs.cache-hit != 'true'
        run: make build.examples

      - name: Test examples
        run: make test.examples

  e2e-tests:
    strategy:
      fail-fast: false
      matrix:
        image: [
          "envoyproxy/envoy-dev:latest",
          "envoyproxy/envoy:v1.19-latest",
          "envoyproxy/envoy:v1.20-latest",
          "envoyproxy/envoy:v1.21-latest",
          "envoyproxy/envoy:v1.22-latest",
          "envoyproxy/envoy:v1.23-latest",
          "istio/proxyv2:1.11.7",
          "istio/proxyv2:1.12.4",
          "istio/proxyv2:1.13.1",
          "istio/proxyv2:1.14.0",
        ]
    name: E2E Test (${{ matrix.image }})
    needs: [examples]
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.image }}
      options: --privileged
    steps:
      - name: Install Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.18'

      - name: Print Envoy version
        run: envoy --version

      - name: Install Make
        run: apt update && apt install make

      - name: Checkout
        uses: actions/checkout@v3

      - name: Fetch built examples
        uses: actions/cache@v3
        with:
          path: examples
          key: examples-${{ hashFiles('examples/**', 'proxywasm/**', 'Makefile') }}-tinygo-${{ env.TINYGO_VERSION }}

      - name: Run e2e test
        run: make test.e2e
        env:
          # Explicitly disable CGO even though we don't use it anywhere. 
          # That is because envoy containers do not have GCC installed
          # plus CGO is enbaled by default, which results in build error.
          CGO_ENABLED: "0"
